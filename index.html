<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        ul { list-style-type: none; padding: 0; }
        li { border: 1px solid #ddd; margin-bottom: 10px; padding: 10px; }
        img { max-width: 100px; height: auto; margin-right: 10px; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        button { padding: 8px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #errorMessage { color: red; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Dashboard</h1>

    <p id="welcomeMessage">Welcome, Guest! Please log in.</p>
    <p id="errorMessage"></p> <!-- Error message section -->

    <a id="loginLink" href="https://autumn-sky-4229.hiplitehehe.workers.dev/login">Login with GitHub</a>
    <a id="logoutLink" href="#" onclick="logout()" style="display:none;">Logout</a>

    <h2>Your Notes</h2>
    <ul id="notesList"></ul>

    <script>
        function checkLogin() {
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get("access_token"); // Get token from URL

            if (accessToken) {
                localStorage.setItem("github_token", accessToken); // Store token
                window.history.replaceState({}, document.title, "/"); // Remove token from URL
                fetchGitHubUser(accessToken); // Fetch GitHub username
            } else {
                displayLoginStatus();
            }
        }

        async function fetchGitHubUser(token) {
            try {
                const response = await fetch("https://api.github.com/user", {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }

                const user = await response.json();

                if (user.login) {
                    localStorage.setItem("username", user.login);
                    document.getElementById("welcomeMessage").textContent = `Welcome, ${user.login}!`;
                    document.getElementById("loginLink").style.display = 'none';
                    document.getElementById("logoutLink").style.display = 'inline-block';
                } else {
                    throw new Error("Failed to retrieve username from GitHub.");
                }
            } catch (error) {
                showError(`Login failed: ${error.message}`);
                logout();
            }
        }

        function showError(message) {
            document.getElementById("errorMessage").textContent = message;
        }

        function displayLoginStatus() {
            const username = localStorage.getItem("username");
            if (username) {
                document.getElementById("welcomeMessage").textContent = `Welcome, ${username}!`;
                document.getElementById("loginLink").style.display = 'none';
                document.getElementById("logoutLink").style.display = 'inline-block';
            } else {
                document.getElementById("welcomeMessage").textContent = "Welcome, Guest! Please log in.";
                document.getElementById("loginLink").style.display = 'inline-block';
                document.getElementById("logoutLink").style.display = 'none';
            }
        }

        function logout() {
            localStorage.removeItem("github_token");
            localStorage.removeItem("username");
            displayLoginStatus();
        }

        checkLogin();
    </script>
</body>
</html>
