<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub OAuth Login</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        #logout { display: none; }
    </style>
</head>
<body>
    <h1>GitHub OAuth Login</h1>
    
    <p id="welcome">Welcome, Guest!</p>
    
    <a id="login" href="#">Login with GitHub</a>
    <button id="logout" onclick="logout()">Logout</button>
    
    <h3>OAuth Response</h3>
    <pre id="responseText">Waiting for login...</pre>

    <script>
        const GITHUB_CLIENT_ID = "Ov23liYtXm2iWIE7t3XZ";  // Replace with your GitHub App Client ID
        const REDIRECT_URI = "https://autumn-sky-4229.hiplitehehe.workers.dev/callback";

        function loginWithGitHub() {
            const authURL = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
            window.location.href = authURL;
        }

        function logout() {
            localStorage.removeItem("username");
            localStorage.removeItem("token");
            window.location.reload();
        }

        async function handleOAuthCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get("code");

            if (code) {
                document.getElementById("responseText").textContent = "Fetching token...";
                
                try {
                    const response = await fetch(REDIRECT_URI + "?code=" + code);
                    const data = await response.json();
                    
                    if (data.access_token) {
                        localStorage.setItem("token", data.access_token);
                        await fetchGitHubUser(data.access_token);
                    } else {
                        document.getElementById("responseText").textContent = "Error: " + JSON.stringify(data);
                    }
                } catch (error) {
                    document.getElementById("responseText").textContent = "Error: " + error.message;
                }
            }
        }

        async function fetchGitHubUser(token) {
            try {
                const response = await fetch("https://api.github.com/user", {
                    headers: { Authorization: "Bearer " + token }
                });
                const user = await response.json();
                
                if (user.login) {
                    localStorage.setItem("username", user.login);
                    document.getElementById("welcome").textContent = "Welcome, " + user.login + "!";
                    document.getElementById("login").style.display = "none";
                    document.getElementById("logout").style.display = "inline-block";
                } else {
                    document.getElementById("responseText").textContent = "GitHub user fetch failed.";
                }
            } catch (error) {
                document.getElementById("responseText").textContent = "GitHub API Error: " + error.message;
            }
        }

        function checkLogin() {
            const username = localStorage.getItem("username");
            if (username) {
                document.getElementById("welcome").textContent = "Welcome, " + username + "!";
                document.getElementById("login").style.display = "none";
                document.getElementById("logout").style.display = "inline-block";
            }
        }

        document.getElementById("login").addEventListener("click", loginWithGitHub);
        checkLogin();
        handleOAuthCallback();
    </script>
</body>
</html>
