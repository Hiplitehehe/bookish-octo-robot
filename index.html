
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub OAuth Notes</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        ul { list-style-type: none; padding: 0; }
        li { border: 1px solid #ddd; margin-bottom: 10px; padding: 10px; }
        img { max-width: 100px; height: auto; margin-right: 10px; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        button { padding: 5px 10px; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>GitHub OAuth Notes</h1>

    <p id="welcomeMessage">Welcome, Guest! Please log in.</p>

    <a id="loginLink" href="https://autumn-sky-4229.hiplitehehe.workers.dev/login">Login with GitHub</a>
    <a id="logoutLink" href="#" onclick="logout()" style="display:none;">Logout</a>

    <h2>Your Notes</h2>
    <ul id="notesList"></ul>

    <script>
        async function fetchNotes() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/Hiplitehehe/Notes/main/Notes.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching notes:', error);
                return [];
            }
        }

        async function approveNote(noteTitle) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('You must be logged in to approve notes.');
                return;
            }

            try {
                const response = await fetch('https://autumn-sky-4229.hiplitehehe.workers.dev/approve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ title: noteTitle })
                });

                const data = await response.json();
                if (response.ok) {
                    alert(`Note "${noteTitle}" approved successfully!`);
                } else {
                    alert(`Error approving note: ${data.message}`);
                }
            } catch (error) {
                console.error('Error approving note:', error);
                alert('Failed to approve note.');
            }
        }

        async function displayNotes() {
            const notesList = document.getElementById("notesList");
            notesList.innerHTML = "";

            const notes = await fetchNotes();
            notes.forEach(note => {
                const li = document.createElement("li");
                li.innerHTML = `
                    <h3>${note.title}</h3>
                    <p>${note.content}</p>
                    <p>Game: ${note.game_name}</p>
                    <img src="${note.game_image_url}" alt="Game image">
                    <img src="${note.note_image_url}" alt="Note image">
                    <p>Submitted by: ${note.user}</p>
                    <a href="note.html?title=${encodeURIComponent(note.title)}">View Note</a>
                    <button onclick="approveNote('${note.title}')" style="display:none;">Approve Note</button>
                `;

                if (localStorage.getItem('access_token')) {
                    li.querySelector('button').style.display = 'block';
                }

                notesList.appendChild(li);
            });
        }

        function checkLogin() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            const loginLink = document.getElementById("loginLink");
            const logoutLink = document.getElementById("logoutLink");

            if (token) {
                document.getElementById("welcomeMessage").textContent = "Logged in!";
                localStorage.setItem('access_token', token);
                loginLink.style.display = 'none';
                logoutLink.style.display = 'inline-block';
            } else if (localStorage.getItem('access_token')) {
                document.getElementById("welcomeMessage").textContent = "Logged in!";
                loginLink.style.display = 'none';
                logoutLink.style.display = 'inline-block';
            } else {
                logoutLink.style.display = 'none';
            }
        }

        function logout(event) {
            event.preventDefault();
            localStorage.removeItem('access_token');
            window.location.href = 'index.html';
        }

        checkLogin();
        displayNotes();
    </script>
</body>
</html>
